<div class="assignments-container">
    <div class="header-section">
        <div>
            <h1>Manage Assignments</h1>
            <p>Assign products to stores in bulk</p>
        </div>
    </div>

    <mat-card class="filter-card">
        <div class="filter-controls">
            <mat-form-field appearance="outline">
                <mat-label>Select Category</mat-label>
                <mat-select [(ngModel)]="selectedCategoryId" (selectionChange)="onCategoryChange()">
                    <mat-option *ngFor="let category of categories" [value]="category.id">
                        {{category.categoryName}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Select Store</mat-label>
                <mat-select [(ngModel)]="selectedStoreId" (selectionChange)="onStoreChange()">
                    <mat-option *ngFor="let store of stores" [value]="store.id">
                        {{store.storeName}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <button mat-raised-button color="primary" (click)="assignSelected()"
                [disabled]="!selectedStoreId || selection.isEmpty() || isLoading">
                <mat-icon>playlist_add</mat-icon> Assign Selected
            </button>
        </div>
    </mat-card>

    <mat-card class="table-card" *ngIf="dataSource && dataSource.data.length > 0">
        <div *ngIf="isLoading" class="loading-overlay">
            <mat-spinner diameter="40"></mat-spinner>
        </div>

        <div class="table-container">
            <table mat-table [dataSource]="dataSource" matSort>

                <!-- Checkbox Column -->
                <ng-container matColumnDef="select">
                    <th mat-header-cell *matHeaderCellDef>
                        <mat-checkbox (change)="$event ? toggleAllRows() : null"
                            [checked]="selection.hasValue() && isAllSelected()"
                            [indeterminate]="selection.hasValue() && !isAllSelected()" [aria-label]="'Select all'">
                        </mat-checkbox>
                    </th>
                    <td mat-cell *matCellDef="let row">
                        <mat-checkbox (click)="$event.stopPropagation()"
                            (change)="$event ? selection.toggle(row) : null" [checked]="selection.isSelected(row)"
                            [disabled]="isAssigned(row.id)" [aria-label]="'Select row'">
                        </mat-checkbox>
                    </td>
                </ng-container>

                <!-- Image Column -->
                <ng-container matColumnDef="imageUrl">
                    <th mat-header-cell *matHeaderCellDef> Image </th>
                    <td mat-cell *matCellDef="let row">
                        <img [src]="row.imageUrl || 'assets/placeholder.png'" class="product-image" alt="Product">
                    </td>
                </ng-container>

                <!-- Name Column -->
                <ng-container matColumnDef="productName">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Product </th>
                    <td mat-cell *matCellDef="let row">
                        <div class="product-name">{{row.productName}}</div>
                        <div class="product-brand" *ngIf="isAssigned(row.id)">
                            <span class="assigned-badge">Already Assigned</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Code Column -->
                <ng-container matColumnDef="productCode">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Code </th>
                    <td mat-cell *matCellDef="let row"> {{row.productCode}} </td>
                </ng-container>

                <!-- Stock Column -->
                <ng-container matColumnDef="stockQuantity">
                    <th mat-header-cell *matHeaderCellDef> Master Stock </th>
                    <td mat-cell *matCellDef="let row"> {{row.stockQuantity}} </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                    (click)="!isAssigned(row.id) ? selection.toggle(row) : null"></tr>
            </table>

            <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of products"></mat-paginator>
        </div>
    </mat-card>

    <div *ngIf="(!dataSource || dataSource.data.length === 0) && selectedCategoryId" class="no-data">
        <p>No products found in this category.</p>
    </div>
</div>